

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Introduction &mdash; Hazel 2.0beta1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Hazel 2.0beta1 documentation" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Hazel
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="programmatically.html">Programmatically</a></li>
<li class="toctree-l1"><a class="reference internal" href="inputOutput.html">Input files</a></li>
<li class="toctree-l1"><a class="reference internal" href="prepareData.html">Data preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="equations.html">Basic Equations</a></li>
<li class="toctree-l1"><a class="reference internal" href="ambiguities.html">Ambiguities in the Hanle effect in the saturation regime</a></li>
<li class="toctree-l1"><a class="reference internal" href="photospheric.html">List of photospheric lines</a></li>
<li class="toctree-l1"><a class="reference internal" href="refsys.html">The reference system</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="disclaimer.html">Disclaimer</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Hazel</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Introduction</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/manual.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h1>
<div class="section" id="description">
<h2>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>&nbsp;(an acronym for HAnle and ZEeman Light) is a computer program for the
synthesis and inversion of Stokes profiles caused by the joint action of
atomic level polarization and the Hanle and Zeeman effects. It is based
on the quantum theory of spectral line polarization, which takes into
account rigorously all the relevant physical mechanisms and ingredients:
optical pumping, atomic level polarization, level crossings and
repulsions, Zeeman, Paschen-Back and Hanle effects. The code is written
in standard Fortran 90. Its parameters are passed using four
configuration files that can be manually edited. These configuration
files are heavily commented, so that their edition should be an easy
task. In any case, two front-ends coded in IDL are given as a part of
the distribution in order to facilitate a user-friendly execution of the
program. A parallel version of the code using Message Passing Interface
(MPI) is also available. This manual considers both distributions.</p>
</div>
<div class="section" id="credits">
<h2>Credits<a class="headerlink" href="#credits" title="Permalink to this headline">¶</a></h2>
<p>The code has grown since the first version thanks to the suggestions of
many people. We thank Rebecca Centeno Elliot, Yukio Katsukawa, Marian
Martínez González, Rafael Manso Sainz and Tom Schad for their help on
testing the code and proposing (and partially coding, in some cases)
some of the options of the code.</p>
</div>
</div>
<div class="section" id="uncompressing-and-compiling">
<h1>Uncompressing and compiling<a class="headerlink" href="#uncompressing-and-compiling" title="Permalink to this headline">¶</a></h1>
<div class="section" id="serial-version">
<h2>Serial version<a class="headerlink" href="#serial-version" title="Permalink to this headline">¶</a></h2>
<p>The package comes in a single compressed file <code class="docutils literal"><span class="pre">hazel.tar.gz</span></code>. After
unpacking with <code class="docutils literal"><span class="pre">tar</span> <span class="pre">zxvf</span> <span class="pre">hazel.tar.gz</span></code>, the &nbsp;directory will contain
the following subdirectories:</p>
<ol class="arabic simple">
<li>Source contains the Fortran 90 sources and a makefile that can be
used to build the binary file.</li>
<li>Run contains a directory tree structure with the appropriate
configuration files to run the code in command line mode.</li>
<li>Widget_Synth contains all the files that are needed to run the IDL
front-end for the synthesis problem.</li>
<li>Widget_Inv contains all the files that are needed to run the IDL
front-end for the inversion problem.</li>
<li>IDL_routines contains some IDL routines that are needed by the
front-ends.</li>
<li>Manual contains this manual.</li>
</ol>
<p>The code has been tested on Linux platforms using the Intel Fortran
Compiler (<code class="docutils literal"><span class="pre">ifort</span></code>) and the free GFortran compiler. The source code is
in the <code class="docutils literal"><span class="pre">Source/</span></code> directory. The compilation is performed with the
supplied <code class="docutils literal"><span class="pre">makefile</span></code>. It is quite simple and easy to modify, and
contains additional comments about compiling. The default compiler is
the <code class="docutils literal"><span class="pre">ifort</span></code>, although you can use any other compiler through the
variable <code class="docutils literal"><span class="pre">COMPILER</span></code>. In order to obtain the executable file, just
type:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="nb">all</span>
</pre></div>
</div>
<p>After compiling and linking, the executable is copied to the &nbsp;<code class="docutils literal"><span class="pre">Run/</span></code>,
<code class="docutils literal"><span class="pre">Widget_Synth/</span></code> and <code class="docutils literal"><span class="pre">Widget_Inv/</span></code> directories. Running the program
in the <code class="docutils literal"><span class="pre">Run/</span></code> directory should produce the correct output depending on
the exact form of the input files.</p>
<p>The generated object and module files can be cleaned typing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">clean</span>
</pre></div>
</div>
</div>
<div class="section" id="parallel-version">
<h2>Parallel version<a class="headerlink" href="#parallel-version" title="Permalink to this headline">¶</a></h2>
<p>The package also decompresses the &nbsp;directory tree that will contain the
following subdirectories:</p>
<ol class="arabic simple">
<li>SourceMPI contains the Fortran 90 sources and a makefile that can be
used to build the binary file.</li>
<li>RunMPI contains a directory tree structure with the appropriate
configuration files to run the code in command line mode.</li>
</ol>
<p>The source code is in the <code class="docutils literal"><span class="pre">SourceMPI/</span></code> directory. The compilation
depends on the precompiled library NetCDF <a class="footnote-reference" href="#id69" id="id1">[2]</a> for reading and writing
output files. NetCDF is a standard for platform independent binary files
that you need to have installed in your system. The compilation is
performed with the supplied <code class="docutils literal"><span class="pre">makefile</span></code>. It is quite simple and easy to
modify, and contains additional comments about compiling. The default
compiler is <code class="docutils literal"><span class="pre">mpif90</span></code>, although you can use any other compiler through
the variable <code class="docutils literal"><span class="pre">COMPILER</span></code>. The variables <code class="docutils literal"><span class="pre">NETCDF_INCLUDE</span></code> and
<code class="docutils literal"><span class="pre">NETCDF_LIB</span></code> have to point to the <code class="docutils literal"><span class="pre">include</span></code> and <code class="docutils literal"><span class="pre">lib</span></code> directories
of the NetCDF distribution.</p>
<p>The code makes use of the MPI package for parallelization, so it has to
be installed on your system. In order to obtain the executable file (for
instance for the Intel compiler), just type:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="o">-</span><span class="n">f</span> <span class="n">makefile</span><span class="o">.</span><span class="n">Intel</span>
</pre></div>
</div>
<p>Modify the <code class="docutils literal"><span class="pre">makefile</span></code> to point the variables to the correct libraries
and include files. After compiling and linking, the executable is copied
to the &nbsp;<code class="docutils literal"><span class="pre">RunMPI/</span></code> directory, where the code is run. Running the
program in the <code class="docutils literal"><span class="pre">RunMPI/</span></code> directory should produce the correct output
depending on the exact form of the input files.</p>
<p>The generated object and module files can be cleaned typing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">clean</span>
</pre></div>
</div>
<p>The code is run from the <code class="docutils literal"><span class="pre">RunMPI</span></code> directory. Use your MPI launcher to
select the number of processors. For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mpiexec</span> <span class="o">-</span><span class="n">n</span> <span class="mi">50</span> <span class="n">hazel_mpi</span> <span class="n">config_inversion</span><span class="o">.</span><span class="n">dat</span> <span class="mi">2000</span> <span class="mi">5000</span>
</pre></div>
</div>
<p>The code admits up to three command line parameters:</p>
<ul class="simple">
<li>Filename with the main configuration file.</li>
<li>Starting pixel of the inversion. This is used if you want to rerun
the inversion of some pixels.</li>
<li>Final pixel of the inversion. This is used if you want to rerun the
inversion of some pixels.</li>
</ul>
<p>See §[sec:phazel_files] for details on the input files.</p>
</div>
</div>
<div class="section" id="new-input-file">
<h1>New input file<a class="headerlink" href="#new-input-file" title="Permalink to this headline">¶</a></h1>
<p>In previous versions of the code, the code was controlled with four
configuration files. The updated version of the code is now controlled
by one human-readable configuration file. The code can still be run
using the old configuration files but this option will be discontinued
in the future so it is advisable to to the shift to this configuration
file. In order to use this option, you need to have the <code class="docutils literal"><span class="pre">configparser</span></code>
package installed in your system. It can be downloaded from
<code class="docutils literal"><span class="pre">http://www.voidspace.org.uk/python/configobj.html</span></code>. The serial code
is now run using:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">run</span><span class="o">.</span><span class="n">py</span> <span class="n">conf</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>and the parallel code is run with</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">run</span><span class="o">.</span><span class="n">py</span> <span class="n">conf</span><span class="o">.</span><span class="n">ini</span> <span class="n">nProcessors</span>
</pre></div>
</div>
<p>An example of the file, that is self-explanatory, is:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Hazel configuration File</span>

<span class="c1">#####################</span>
<span class="c1"># General information</span>
<span class="c1">#####################</span>

<span class="p">[</span><span class="n">Files</span><span class="p">]</span>
<span class="n">Input</span> <span class="n">model</span> <span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;ATOMS/helium.mod&#39;</span>
<span class="n">File</span> <span class="k">with</span> <span class="n">observations</span> <span class="o">=</span> <span class="s1">&#39;OBSERVATION/test_2comp.prof&#39;</span>
<span class="n">File</span> <span class="k">with</span> <span class="n">inverted</span> <span class="n">profiles</span> <span class="o">=</span> <span class="s1">&#39;test.inversion&#39;</span>
<span class="n">File</span> <span class="k">with</span> <span class="n">inverted</span> <span class="n">parameters</span> <span class="o">=</span> <span class="s1">&#39;test.parameters&#39;</span>

<span class="p">[</span><span class="n">Working</span> <span class="n">mode</span><span class="p">]</span>
<span class="n">Action</span> <span class="o">=</span> <span class="s1">&#39;inversion&#39;</span>                        <span class="c1"># &#39;synthesis&#39; or &#39;inversion&#39;</span>
<span class="n">Verbose</span> <span class="o">=</span> <span class="n">no</span>
<span class="n">Linear</span> <span class="n">system</span> <span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;LU&#39;</span>                 <span class="c1"># &#39;LU&#39; or &#39;CG&#39;</span>
<span class="n">Stopping</span> <span class="n">volume</span> <span class="k">for</span> <span class="n">DIRECT</span> <span class="o">=</span> <span class="mf">0.001</span>

<span class="p">[</span><span class="n">General</span> <span class="n">parameters</span><span class="p">]</span>
<span class="n">Synthesis</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;exact&#39;</span>                    <span class="c1"># &#39;thin&#39; or &#39;exact&#39;</span>
<span class="n">Include</span> <span class="n">stimulated</span> <span class="n">emission</span> <span class="o">=</span> <span class="n">yes</span>
<span class="n">Include</span> <span class="n">magnetic</span> <span class="n">field</span>  <span class="o">=</span> <span class="n">yes</span>
<span class="n">Include</span> <span class="n">Paschen</span><span class="o">-</span><span class="n">Back</span> <span class="n">effect</span> <span class="o">=</span> <span class="n">yes</span>
<span class="n">Include</span> <span class="n">atomic</span> <span class="n">level</span> <span class="n">polarization</span> <span class="o">=</span> <span class="n">yes</span>
<span class="n">Include</span> <span class="n">magneto</span><span class="o">-</span><span class="n">optical</span> <span class="n">effects</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">RT</span> <span class="o">=</span> <span class="n">yes</span>
<span class="n">Include</span> <span class="n">stimulated</span> <span class="n">emission</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">RT</span> <span class="o">=</span> <span class="n">yes</span>
<span class="n">Multiplet</span> <span class="o">=</span> <span class="mi">10830</span>                           <span class="c1"># 10830, 5876, 7065, 3889 A</span>
<span class="n">Line</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">sight</span> <span class="n">angles</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">90.0</span>       <span class="c1"># theta, chi, gamma deg</span>
<span class="n">Wavelength</span> <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">200</span>            <span class="c1"># Minimum, maximum and number of grid points</span>

<span class="c1">#####################</span>
<span class="c1"># Synthesis parameters</span>
<span class="c1">#####################</span>
<span class="p">[</span><span class="n">Synthesis</span><span class="p">]</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">slabs</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>                       <span class="c1"># &#39;1&#39; -&gt; single slab, &#39;1+1&#39; -&gt; two slabs with same field, &#39;1+1B&#39; -&gt; 2 slabs with different field, &#39;2&#39; -&gt; two slabs added with a filling factor</span>
<span class="n">Boundary</span> <span class="n">condition</span> <span class="o">=</span> <span class="mf">4.098e-5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>      <span class="c1"># I0, Q0, U0, V0</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">height</span> <span class="o">=</span> <span class="mf">3.0</span>                                <span class="c1"># Real height if positive, apparent height if negative arcsec</span>
<span class="n">ff</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="p">[[</span><span class="n">Slab</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="n">B</span> <span class="o">=</span>         <span class="mf">0.0</span>         <span class="c1"># G</span>
    <span class="n">thetaB</span> <span class="o">=</span>    <span class="mf">0.0</span>         <span class="c1"># deg</span>
    <span class="n">chiB</span> <span class="o">=</span>      <span class="mf">0.0</span>         <span class="c1"># deg</span>
    <span class="n">vdopp</span> <span class="o">=</span>     <span class="mf">8.0</span>         <span class="c1"># km/s</span>
    <span class="n">tau</span> <span class="o">=</span>       <span class="mf">1.0</span>
    <span class="n">vmac</span> <span class="o">=</span>      <span class="mf">0.0</span>         <span class="c1"># Positive is redshift km/s</span>
    <span class="n">beta</span> <span class="o">=</span>      <span class="mf">1.0</span>
    <span class="p">[[</span><span class="n">Slab</span> <span class="mi">2</span><span class="p">]]</span>
    <span class="n">B</span> <span class="o">=</span>         <span class="mf">0.0</span>         <span class="c1"># G</span>
    <span class="n">thetaB</span> <span class="o">=</span>    <span class="mf">0.0</span>         <span class="c1"># deg</span>
    <span class="n">chiB</span> <span class="o">=</span>      <span class="mf">0.0</span>         <span class="c1"># deg</span>
    <span class="n">vdopp</span> <span class="o">=</span>     <span class="mf">0.0</span>         <span class="c1"># km/s</span>
    <span class="n">tau</span> <span class="o">=</span>       <span class="mf">0.0</span>
    <span class="n">vmac</span> <span class="o">=</span>      <span class="mf">0.0</span>         <span class="c1"># Positive is redshift km/s</span>
    <span class="n">beta</span> <span class="o">=</span>      <span class="mf">1.0</span>

<span class="c1">#####################</span>
<span class="c1"># Ranges for the DIRECT method [min, max]</span>
<span class="c1">#####################</span>
<span class="p">[</span><span class="n">Ranges</span><span class="p">]</span>
<span class="n">a</span> <span class="o">=</span>             <span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span>
<span class="n">ff</span> <span class="o">=</span>            <span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span>
    <span class="p">[[</span><span class="n">Slab</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="n">B</span> <span class="o">=</span>         <span class="mi">800</span><span class="p">,</span><span class="mi">1100</span>
    <span class="n">thetaB</span> <span class="o">=</span>    <span class="mi">0</span><span class="p">,</span><span class="mi">180</span>
    <span class="n">chiB</span> <span class="o">=</span>      <span class="mi">0</span><span class="p">,</span><span class="mi">180</span>
    <span class="n">vdopp</span> <span class="o">=</span>     <span class="mi">2</span><span class="p">,</span><span class="mi">12</span>
    <span class="n">tau</span> <span class="o">=</span>       <span class="mf">0.1</span><span class="p">,</span><span class="mi">2</span>
    <span class="n">vmac</span> <span class="o">=</span>      <span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span>
    <span class="n">beta</span> <span class="o">=</span>      <span class="mf">0.5</span><span class="p">,</span><span class="mi">2</span>
    <span class="p">[[</span><span class="n">Slab</span> <span class="mi">2</span><span class="p">]]</span>
    <span class="n">B</span> <span class="o">=</span>         <span class="mi">800</span><span class="p">,</span><span class="mi">1100</span>
    <span class="n">thetaB</span> <span class="o">=</span>    <span class="mi">0</span><span class="p">,</span><span class="mi">180</span>
    <span class="n">chiB</span> <span class="o">=</span>      <span class="mi">0</span><span class="p">,</span><span class="mi">180</span>
    <span class="n">vdopp</span> <span class="o">=</span>     <span class="mi">2</span><span class="p">,</span><span class="mi">12</span>
    <span class="n">tau</span> <span class="o">=</span>       <span class="mf">0.1</span><span class="p">,</span><span class="mi">2</span>
    <span class="n">vmac</span> <span class="o">=</span>      <span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span>
    <span class="n">beta</span> <span class="o">=</span>      <span class="mf">0.5</span><span class="p">,</span><span class="mi">2</span>

<span class="c1">#####################</span>
<span class="c1"># Parameters to invert</span>
<span class="c1">#####################</span>
<span class="p">[</span><span class="n">Inversion</span><span class="p">]</span>
<span class="n">Iterations</span> <span class="ow">in</span> <span class="n">LM</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">cycles</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">Inversion</span> <span class="n">modes</span> <span class="o">=</span> <span class="s1">&#39;DIRECT&#39;</span><span class="p">,</span> <span class="s1">&#39;LM&#39;</span><span class="p">,</span> <span class="s1">&#39;DIRECT&#39;</span><span class="p">,</span> <span class="s1">&#39;LM&#39;</span>        <span class="c1"># &#39;DIRECT&#39; for DIRECT algorithm and &#39;LM&#39; for Levenberg-Marquardt</span>
    <span class="p">[[</span><span class="n">Cycles</span><span class="p">]]</span>
    <span class="n">a</span> <span class="o">=</span>             <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">ff</span> <span class="o">=</span>            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="p">[[[</span><span class="n">Slab</span> <span class="mi">1</span><span class="p">]]]</span>
        <span class="n">B</span> <span class="o">=</span>         <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">thetaB</span> <span class="o">=</span>    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">chiB</span> <span class="o">=</span>      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">vdopp</span> <span class="o">=</span>     <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">tau</span> <span class="o">=</span>       <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">vmac</span> <span class="o">=</span>      <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">beta</span> <span class="o">=</span>      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="p">[[[</span><span class="n">Slab</span> <span class="mi">2</span><span class="p">]]]</span>
        <span class="n">B</span> <span class="o">=</span>         <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">thetaB</span> <span class="o">=</span>    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">chiB</span> <span class="o">=</span>      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">vdopp</span> <span class="o">=</span>     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">tau</span> <span class="o">=</span>       <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">vmac</span> <span class="o">=</span>      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">beta</span> <span class="o">=</span>      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="p">[[</span><span class="n">Weights</span><span class="p">]]</span>
        <span class="n">Stokes</span> <span class="n">I</span> <span class="o">=</span>  <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span>
        <span class="n">Stokes</span> <span class="n">Q</span> <span class="o">=</span>  <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span>
        <span class="n">Stokes</span> <span class="n">U</span> <span class="o">=</span>  <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span>
        <span class="n">Stokes</span> <span class="n">V</span> <span class="o">=</span>  <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
<div class="section" id="input-files">
<h1>Input files<a class="headerlink" href="#input-files" title="Permalink to this headline">¶</a></h1>
<p>&nbsp;is controlled via four configuration files. All configuration files are
fully commented, so that changing any parameter should be an easy task.
In the following, we describe them step by step.</p>
<div class="section" id="config-inversion-dat">
<h2><code class="docutils literal"><span class="pre">config_inversion.dat</span></code><a class="headerlink" href="#config-inversion-dat" title="Permalink to this headline">¶</a></h2>
<p>This file can be considered as the main configuration file and it is the
only one that has to have a fixed name. This file is used to indicate
the names of the input files, the names of the output files, verbosity
level and to decide whether &nbsp;is to be applied to work in synthesis or
inversion mode. Using the example included in the present version of ,
we analyze one by one all the inputs.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Input model file</span>
<span class="s1">&#39;ATOMS/helium.mod&#39;</span>
</pre></div>
</div>
<p>Definition of the file with the atomic model. See §[sec:atomic_model]
for an explanation of the file format.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Initial parameters file</span>
<span class="s1">&#39;init_parameters.dat&#39;</span>
</pre></div>
</div>
<p>Definition of the file with the initial parameters of the problem. The
values of the parameters in this file are taken as initial values for
the inversion or for the synthesis. See §[sec:init_parameters] for a
detailed description of the file.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Range of parameters for the DIRECT method</span>
<span class="s1">&#39;direct_range.dat&#39;</span>
</pre></div>
</div>
<p>This file is used to define the lower and upper limits of the intervals
inside which the DIRECT method searches for the minimum of the
<span class="math">\(\chi^2\)</span> function. See §[sec:direct_range] for details.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Output for the upper level rho^K_Q(J,J&#39;) in the vertical reference frame</span>
<span class="s1">&#39;ATOMIC_POL/vertical_upper.rho&#39;</span>

<span class="c1"># Output for the lower level rho^K_Q(J,J&#39;) in the vertical reference frame</span>
<span class="s1">&#39;ATOMIC_POL/vertical_lower.rho&#39;</span>

<span class="c1"># Output for the upper level rho^K_Q(J,J&#39;) in the mag. field reference frame</span>
<span class="s1">&#39;ATOMIC_POL/magnetic_upper.rho&#39;</span>

<span class="c1"># Output for the lower level rho^K_Q(J,J&#39;) in the mag. field reference frame</span>
<span class="s1">&#39;ATOMIC_POL/magnetic_lower.rho&#39;</span>
</pre></div>
</div>
<p>The previous lines define the output files where the spherical tensor
components of the density matrix are saved. Note that the code stores
only the density matrix elements of the upper and lower level of the
desired transition. The elements of the atomic density matrix depend on
the chosen reference system, and the two most desired reference systems
are the one in which the quantization axis is chosen along the solar
local vertical direction and the one in which the quantization axis is
chosen along the magnetic field vector.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Output absorption/emission coefficients</span>
<span class="s1">&#39;INVERTED/rtcoef.emer&#39;</span>

<span class="c1"># Output absorption/emission coefficients neglecting atomic polarization</span>
<span class="s1">&#39;INVERTED/rtcoef_noatompol.emer&#39;</span>
</pre></div>
</div>
<p>The emission coefficients <span class="math">\(\epsilon_{I,Q,U,V}\)</span>, the absorption
coefficients <span class="math">\(\eta_{I,Q,U,V}\)</span> and the anomalous dispersion
coefficients <span class="math">\(\rho_{Q,U,V}\)</span> for each wavelength point are saved in
these files. The first file includes the effects of atomic level
polarization, while the second one neglects its influence.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># File with the observed profiles</span>
<span class="s1">&#39;OBSERVATION/test.prof&#39;</span>
</pre></div>
</div>
<p>When using the code in the inversion mode, this file is the one used for
the input of the observed Stokes profiles. The format of this file
depends on which version of the code is used. For , it is very simple.
The first line indicates the number of wavelength points and the
normalization (use ’cont’ or ’peak’). Then, a table with nine columns
gives the value of the wavelength shift with respect to the center of
the multiplet, the Stokes vector at each wavelength normalized to the
maximum intensity, and an estimation of the noise standard deviation at
each wavelength normalized to the maximum intensity. See the example
file contained in the &nbsp;distribution for more details. Note that these
lines have to be present in the input file even if &nbsp;is used in synthesis
mode.</p>
<p>When using , the input file is more complicated and is described in
§[sec:phazel_files].</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># File with the inverted profiles</span>
<span class="s1">&#39;test.inversion&#39;</span>

<span class="c1"># File with the parameters from the inversion</span>
<span class="s1">&#39;test.parameters&#39;</span>
</pre></div>
</div>
<p>The final Stokes profiles resulting from the synthesis or inversion
options is saved in the file indicated in the first line. The format is
the same as that explained for the file containing the observation. When
&nbsp;is run in inversion mode, the final inferred parameters of the model
are saved in the file indicated in the second line. Again, for &nbsp;the
output files are described in §[sec:phazel_files].</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># File that sets the parameters to invert</span>
<span class="s1">&#39;invert_parameters.dat&#39;</span>
</pre></div>
</div>
<p>This file defines which parameters to invert in the inversion mode,
together with the algorithm to be used in each cycle and the weight used
for each Stokes parameter.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Verbose mode (0-&gt; no, 1-&gt; yes)</span>
<span class="mi">0</span>
</pre></div>
</div>
<p>Flag to connect or disconnect the verbose mode. For the inversion of
Stokes profiles affected by atomic level polarization it is sometimes
useful to turn the verbose mode on for analyzing the process of the code
while calculating.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Linear system solver (0-&gt; LU, 1-&gt; CG)</span>
<span class="mi">0</span>
</pre></div>
</div>
<p>This flag is used to choose the algorithm that solves the linear system
of statistical equilibrium equations. For relatively simple models, the
LU decomposition does a very good job in terms of speed. If the number
of unknowns (i.e., of <span class="math">\(\rho^K_Q(J,J')\)</span> elements) turns out to be
of the order of or larger than <span class="math">\(10^3\)</span>, conjugate gradients (CG)
methods are a much better option. We recommend to use the LU
decomposition when possible and move to the CG solution only when
necessary. The CG solution are based on routines developed by Dr. Mark
K. Seager from Lawrence Livermore National Lab.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Optically thin (0), slab no-MO (1), M-E (2), slab DELOPAR (3),</span>
                       <span class="n">simplified</span> <span class="n">slab</span> <span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">exact</span> <span class="n">slab</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="mi">5</span>
</pre></div>
</div>
<p>This flag is used to choose the level of approximation for the solution
of the radiative transfer equation. The meaning of each option is
explained below in §[sec:radiative_transfer].</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Synthesis mode -&gt; 0 , Inversion mode -&gt; 1</span>
<span class="mi">0</span>
</pre></div>
</div>
<p>This flag controls the working mode of the code (synthesis or
inversion).</p>
</div>
<div class="section" id="init-parameters-dat">
<h2><code class="docutils literal"><span class="pre">init_parameters.dat</span></code><a class="headerlink" href="#init-parameters-dat" title="Permalink to this headline">¶</a></h2>
<p>This important file establishes the parameters of the model, together
with the definition of the scattering geometry. It includes also flags
to turn on or discard different physical mechanisms. In the synthesis
mode, the values in this file are used to carry out the synthesis. In
the inversion mode, the values in this file are chosen as initial
conditions for the inversion for those parameters that are left free.
For those that are left fixed, the code uses the values defined in this
file. We explain them step by step.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Include stimulated emission (0-&gt; no, 1-&gt; yes)</span>
<span class="mi">1</span>
</pre></div>
</div>
<p>This flag is used to take into account or discard the effect of
stimulated emission in the emergent Stokes profiles. Although stimulated
emission is negligible for most solar it can be of importance for very
strong radiation fields. We recommend to use always 1 since the
computational time is barely affected by this flag.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Include magnetic field (0-&gt; no, 1-&gt; yes)</span>
<span class="mi">1</span>
</pre></div>
</div>
<p>This flag is used to slightly reduce the computational work for the
non-magnetic case because, if set to zero, the magnetic kernel [see Eq.
([eq:see])] is not calculated.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Include depolarization rates (0-&gt; no, 1-&gt; yes)</span>
<span class="mi">0</span>

<span class="c1"># Value of delta if depol. rates are included (not used if prev. value = 0)</span>
<span class="mf">1.</span><span class="n">d14</span>
</pre></div>
</div>
<p>In the present version of &nbsp;it is possible to include the effect of
depolarizing collisions only in the ground level of the atomic system.
In case the effect of collisions is to be accounted for, set the first
parameter to 1 and give the collisional rate in the next parameter in
units of s<span class="math">\(^{-1}\)</span>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Include Paschen-Back effect (0-&gt; no, 1-&gt; yes)</span>
<span class="mi">1</span>
</pre></div>
</div>
<p>The effect of a magnetic field on the energy levels of the atomic system
can be calculated under the approximation of the linear Zeeman effect or
in the general case of the intermediate Paschen-Back effect. If this
flag is set to 0, the approximation of the linear Zeeman effect is used
and no perturbations between different <span class="math">\(J\)</span> levels of a term are
taken into account. If the flag is set to 1, the general theory of the
Paschen-Back effect is used to calculate the wavelength positions and
the strengths of the <span class="math">\(\pi\)</span> and <span class="math">\(\sigma\)</span> components. The
difference in the computational work between both approaches is rather
small.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Number of slabs (1-&gt; 1 slab, 2-&gt; 2 slabs with same B,</span>
<span class="mi">3</span><span class="o">-&gt;</span> <span class="mi">2</span> <span class="n">slabs</span> <span class="k">with</span> <span class="n">different</span> <span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">-&gt;</span> <span class="mi">2</span> <span class="n">slabs</span> <span class="k">with</span> <span class="n">filling</span> <span class="n">factor</span><span class="p">)</span>
</pre></div>
</div>
<p>&nbsp;can be used using one slab (option 1) of constant physical properties
or two (options 2 and 3 and -2). The difference between options 2 and 3
is that option 2 considers both slabs to have exactly the same field
while option 3 considers two different fields. As a consequence, the
computing time is smaller in option 2. In both options, the second slab
is placed in front of the first one, so that the boundary condition of
the second slab is the emergent radiation from the first. In option -2,
the radiation emerging from both slabs is added weighted with a filling
factor, which is indicated below.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Magnetic field strength [G], thetaB [degrees], chiB [degrees]</span>
<span class="mf">0.3</span><span class="n">d0</span> <span class="mf">90.</span><span class="n">d0</span> <span class="mf">90.</span><span class="n">d0</span>
</pre></div>
</div>
<p>The magnetic field vector is defined here. The strength in G and the
inclination and azimuth angles in degrees define the magnetic field
vector. The angles are defined with respect to the vertical direction in
the atmosphere, as shown in Fig. [fig:geometry]. Note that, if the
azimuth of the field is set to 999, the random azimuth solution is
obtained following the strategy explained in Appendix C of
<a href="#id2"><span class="problematic" id="id3">:raw-latex:`\cite{belluzzi07}`</span></a>. If two slabs are used (setting option 3
or -2 above), put the two field vectors next to each one in the format
<span class="math">\((B,\theta_B,\chi_B)_1 (B,\theta_B,\chi_B)_2\)</span>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Apparent height (if &lt;0) or real height (if &gt;0) of the atoms in arcsec</span>
<span class="mf">3.</span><span class="n">d0</span>
</pre></div>
</div>
<p>The tensors <span class="math">\(J^0_0\)</span> and <span class="math">\(J^2_0\)</span> that quantify the mean
intensity of the radiation field and its anisotropy are calculated
assuming a standard solar center-to-limb variation (CLV) and taking into
account geometrical effects. This parameter gives the height at which
the slab of atoms is placed with respect to the surface of the Sun.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Optical depth of the slab in the maximum of I (slab) or strength of the line (ME)</span>
<span class="mf">1.0</span><span class="n">d0</span>
</pre></div>
</div>
<p>This quantity is the optical depth of the slab at the wavelength
position of the maximum absorption or emission in Stokes <span class="math">\(I\)</span>. For
example, for the 10830 Å&nbsp;multiplet of He i, this is the position of the
red blended component. If two slabs with option 2 or 3 are used, put the
two optical depths together. If option -2 is used, then add the filling
factor as a third number.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Source function increase</span>
<span class="mf">1.</span><span class="n">d0</span>
</pre></div>
</div>
<p>The source function of the slab will be multiplied by this number. This
is a way to generate lines in emission even when the slab is seen on the
solar disk. If two components (one after the other) are used, this
number only modifies the source function of the second component. This
allows us to simulate self-absorption in the code.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Boundary Stokes parameters (I0,Q0,U0,V0)</span>
<span class="mf">4.098</span><span class="n">d</span><span class="o">-</span><span class="mi">5</span> <span class="mf">0.</span><span class="n">d0</span> <span class="mf">0.</span><span class="n">d0</span> <span class="mf">0.</span><span class="n">d0</span>
</pre></div>
</div>
<p>Boundary conditions for the Stokes vector used in the solution of the
radiative transfer equation. If the radiation field is the photospheric
continuum, the IDL routine <code class="docutils literal"><span class="pre">IDL_routines/solar_field.pro</span></code> can be used
to return an estimation.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Transition where to compute the emergent Stokes profiles</span>
<span class="mi">1</span>
</pre></div>
</div>
<p>From the transitions defined in the atomic model, the code calculates
the emergent Stokes profiles for the chosen transition. For the moment,
only one transition at a time is allowed. We plan to extend this to
synthesize several lines.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Include atomic level polarization? (0-&gt; no, 1-&gt; yes)</span>
<span class="mi">1</span>
</pre></div>
</div>
<p>The synthesis or inversion options can be used taking into account or
neglecting the presence of atomic level polarization. This flag controls
it.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Observation angle with respect to the local solar vertical theta,chi,gamma [degrees]</span>
<span class="mf">0.</span><span class="n">d0</span> <span class="mf">0.</span><span class="n">d0</span> <span class="mf">90.</span><span class="n">d0</span>
</pre></div>
</div>
<p>The line-of-sight direction is defined using the angles described in
Fig. [fig:geometry]. All angles are given in degrees.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Wavelength axis: minimum, maximum and number of grid points</span>
<span class="o">-</span><span class="mf">3.</span><span class="n">d0</span> <span class="mf">2.5</span><span class="n">d0</span> <span class="mi">200</span>
</pre></div>
</div>
<p>In case the code is run in synthesis mode, this line is used to set the
lower and upper limits (in cm<span class="math">\(^{-1}\)</span>) of the wavelength axis.
The last parameter gives the number of wavelength points to be used. In
the inversion mode, the wavelength axis is chosen automatically from the
observation and these numbers are overridden.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Line wavelength [A], Doppler velocity [km/s] and damping [a]</span>
<span class="mf">10829.0911</span><span class="n">d0</span>   <span class="mf">6.5</span><span class="n">d0</span>   <span class="mf">0.</span><span class="n">d0</span>
</pre></div>
</div>
<p>This line is used to define the wavelength of the multiplet (wavelength
of the <span class="math">\((L,S) \to (L',S')\)</span> transition), the Doppler width of the
line in km s<span class="math">\(^{-1}\)</span> and the reduced damping constant. If two
slabs (through options 3 or -2) are used, add the Doppler width of the
second component next to the first one. Concerning the reduced damping
constant, if its value is negative, it is computed using the natural
damping and using the Doppler broadening. The absolute value of the
input value is used then as an enhancement factor (so you should use
<span class="math">\(-1\)</span> is you want to use the natural width).</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Macroscopic velocity [km/s] (&gt;0 is a redshift)</span>
<span class="mf">0.</span><span class="n">d0</span>
</pre></div>
</div>
<p>This defines the wavelength shift produced by the presence of a bulk
motion of the plasma. Note that positive velocities imply redshifts. If
two components (options 2, 3 or -2) are used, put the two bulk
velocities.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Include magneto-optical effects in the RT</span>
<span class="mi">1</span>
</pre></div>
</div>
<p>It is possible to include (1) or neglect (0) the influence of the
anomalous dispersion coefficients <span class="math">\(\rho_{Q,U,V}\)</span> in the
calculation of the emergent Stokes profiles.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Include stimulated emission in the RT</span>
<span class="mi">1</span>
</pre></div>
</div>
<p>This flag controls whether we include (1) or neglect (0) the influence
of the stimulated emission in the calculation of the emergent Stokes
profiles.</p>
</div>
<div class="section" id="direct-range-dat">
<h2><code class="docutils literal"><span class="pre">direct_range.dat</span></code><a class="headerlink" href="#direct-range-dat" title="Permalink to this headline">¶</a></h2>
<p>The DIRECT global optimization method is used to give a first estimation
of the parameters from which the Levenberg-Marquardt method is applied
to locate the minimum of the <span class="math">\(\chi^2\)</span> surface. The behavior of the
DIRECT method is controlled with this file, in which we must specify the
upper and lower limits of the model parameters, together with details
about the stopping criterion. In the following, we describe all the
options in detail.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Output file</span>
<span class="s1">&#39;direct.location&#39;</span>
</pre></div>
</div>
<p>The DIRECT method tries to evaluate the merit function <span class="math">\(\chi^2\)</span> as
few times as possible. The code saves in this file the values of the
parameters at which the algorithm has carried out the evaluation of the
merit function. This can be useful for analyzing the presence of
ambiguities. In this case, the method will clearly mark the position of
the possible solutions by evaluating the merit function more times in
the surroundings of the compatible solutions. Note that this lines are
absent on the &nbsp;configuration file.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Maximum number of function evaluations (&lt;0 -&gt; don&#39;t use this criteria)</span>
<span class="o">-</span><span class="mi">1</span>

<span class="c1"># Reduction in the volume (&lt;0 -&gt; don&#39;t use this criteria, typically 0.01)</span>
<span class="mf">0.001</span>
</pre></div>
</div>
<p>The previous two lines are used to indicate the stopping criterion for
the DIRECT method. An early stop will probably give a first estimation
of the solution that is far from the final result. Letting the code run
for many iterations may degrade too much the computing time because of
the poor local convergence properties of the DIRECT scheme. The first
option permits the user to stop after a fixed number of evaluations of
the merit function. The second option permits the user to stop when the
ratio between the hypervolume where the global minimum is located and
the original hypervolume is smaller than the given threshold. We have
verified that 0.001 gives very good results. Setting one of the two
parameters to values <span class="math">\(&lt; 0\)</span> will disconnect it.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Magnetic field (0-Bmax)</span>
<span class="mf">800.</span><span class="n">d0</span>  <span class="mf">1100.</span><span class="n">d0</span>

<span class="c1"># thetab  (0 .. 180)</span>
<span class="mf">30.</span><span class="n">d0</span>  <span class="mf">180.</span><span class="n">d0</span>

<span class="c1"># chib (0 .. 180)</span>
<span class="o">-</span><span class="mf">180.</span><span class="n">d0</span>  <span class="mf">0.</span><span class="n">d0</span>

<span class="c1"># vdopp (0 .. 20)</span>
<span class="mf">2.</span><span class="n">d0</span>  <span class="mf">7.</span><span class="n">d0</span>

<span class="c1"># dtau (0 .. 5)</span>
<span class="mf">0.</span><span class="n">d0</span>  <span class="mf">1.</span><span class="n">d0</span>

<span class="c1"># delta_collision (0 .. 18)</span>
<span class="mf">0.</span><span class="n">d0</span>  <span class="mf">18.</span><span class="n">d0</span>

<span class="c1"># vmacro (-10 .. 10)</span>
<span class="o">-</span><span class="mf">10.</span><span class="n">d0</span>  <span class="mf">10.</span><span class="n">d0</span>

<span class="c1"># damping (0 .. 4)</span>
<span class="mf">0.</span><span class="n">d0</span>  <span class="mf">4.</span><span class="n">d0</span>

<span class="c1"># beta (0 .. 10)</span>
<span class="mf">0.</span><span class="n">d0</span>  <span class="mf">1.</span><span class="n">d0</span>

<span class="c1"># height (0 .. 100)</span>
<span class="mf">0.</span><span class="n">d0</span>  <span class="mf">100.</span><span class="n">d0</span>

<span class="c1"># dtau2 (0 .. 5)</span>
<span class="mf">0.</span><span class="n">d0</span>  <span class="mf">2.</span><span class="n">d0</span>

<span class="c1"># vmacro2 (-10 .. 10)</span>
<span class="mf">25.</span><span class="n">d0</span>  <span class="mf">35.</span><span class="n">d0</span>

<span class="c1"># Magnetic field 2 (0-Bmax)</span>
<span class="mf">800.</span><span class="n">d0</span>  <span class="mf">1100.</span><span class="n">d0</span>

<span class="c1"># thetab 2 (0 .. 180)</span>
<span class="mf">30.</span><span class="n">d0</span>  <span class="mf">180.</span><span class="n">d0</span>

<span class="c1"># chib 2 (0 .. 180)</span>
<span class="o">-</span><span class="mf">180.</span><span class="n">d0</span>  <span class="mf">0.</span><span class="n">d0</span>

<span class="c1"># vdopp 2 (0 .. 20)</span>
<span class="mf">2.</span><span class="n">d0</span>  <span class="mf">12.</span><span class="n">d0</span>
</pre></div>
</div>
<p>The previous lines define the space of parameters where the DIRECT
method will look for the global minimum.</p>
</div>
<div class="section" id="invert-parameters-dat">
<h2><code class="docutils literal"><span class="pre">invert_parameters.dat</span></code><a class="headerlink" href="#invert-parameters-dat" title="Permalink to this headline">¶</a></h2>
<p>This file is used to set the behavior of the inversion mode: the
structure of the inversion cycle, setting the free and the fixed
parameters.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Maximum number of iterations</span>
<span class="mi">20</span>
</pre></div>
</div>
<p>This parameter sets the maximum number of Levenberg-Marquardt (LM)
iterations to be carried out in each cycle. Sometimes the LM scheme
stops before reaching the maximum number of iterations because the
relative change in the parameters from one iteration to the next is
below 10<span class="math">\(^{-4}\)</span>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Number of cycles</span>
<span class="mi">2</span>
</pre></div>
</div>
<p>The optimal iteration scheme is composed of combinations of cycles. In
the first cycle, the DIRECT method is used to give a first estimation of
the solution. In the second cycle, the LM method is used to refine the
solution until arriving to the final one. This parameter sets the number
of cycles used.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Invert the magnetic field strength</span>
<span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span>

<span class="c1"># Invert the magnetic field inclination</span>
<span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span>

<span class="c1"># Invert the magnetic field azimuth</span>
<span class="mi">1</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="c1"># Invert the Doppler width</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="c1"># Invert the optical depth or strength of the line</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="c1"># Invert the D^2 of the lower level</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="c1"># Invert the macroscopic velocity</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="c1"># Invert the damping</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="c1"># Invert the source function gradient</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="c1"># Invert the height of the He atoms</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="c1"># Invert the optical depth or strength of the line of component 2</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="c1"># Invert the macroscopic velocity of component 2</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="c1"># Invert the magnetic field strength of component 2</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">1</span>

<span class="c1"># Invert the magnetic field inclination of component 2</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">1</span>

<span class="c1"># Invert the magnetic field azimuth of component 2</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">1</span>

<span class="c1"># Invert the Doppler width of component 2</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Depending on the number of cycles, the previous lines define whether a
parameter is inverted (setting a 1 in the corresponding cycle) or kept
fixed to the value given in the <code class="docutils literal"><span class="pre">init_parameters.dat</span></code> file (setting a
0 in the corresponding cycle). The number of 0s/1s in each line has to
be larger or equal to the number of cycles.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Weights for Stokes I in each cycle</span>
<span class="mf">1.</span><span class="n">d0</span> <span class="mf">1.</span><span class="n">d0</span> <span class="mf">1.</span><span class="n">d0</span> <span class="mf">1.</span><span class="n">d0</span>

<span class="c1"># Weights for Stokes Q in each cycle</span>
<span class="mf">1.</span><span class="n">d0</span> <span class="mf">1.</span><span class="n">d0</span> <span class="mf">1.</span><span class="n">d0</span> <span class="mf">1.</span><span class="n">d0</span>

<span class="c1"># Weights for Stokes U in each cycle</span>
<span class="mf">1.</span><span class="n">d0</span> <span class="mf">1.</span><span class="n">d0</span> <span class="mf">1.</span><span class="n">d0</span> <span class="mf">1.</span><span class="n">d0</span>

<span class="c1"># Weights for Stokes V in each cycle</span>
<span class="mf">1.</span><span class="n">d0</span> <span class="mf">1.</span><span class="n">d0</span> <span class="mf">1.</span><span class="n">d0</span> <span class="mf">1.</span><span class="n">d0</span>
</pre></div>
</div>
<p>Since the inversion is based on the gradient descent minimization of the
<span class="math">\(\chi^2\)</span> merit function and not on sampling methods, it is
important to modify sometimes the weight of each Stokes vector in order
to increase the sensitivity of the <span class="math">\(\chi^2\)</span>-function to some model
parameters. The code allows to change the relative weight of each Stokes
vector in each cycle.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Inversion modes (1-&gt; LM, 2-&gt; DIRECT, 3-&gt; PIKAIA)</span>
<span class="mi">2</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">1</span>
</pre></div>
</div>
<p>The optimization method used in each cycle is set in this line. Note
that the scheme DIRECT+LM has been empirically proved to be quite
optimal. The possibility to use genetic optimization based on the Pikaia
algorithm is still in a preliminary phase. However, the large number of
function evaluations that any genetic algorithm needs makes it difficult
to beat the DIRECT+LM combination.</p>
</div>
<div class="section" id="ambiguities">
<h2>Ambiguities<a class="headerlink" href="#ambiguities" title="Permalink to this headline">¶</a></h2>
<p>You have to remember that the results of Hazel are potentially affected
by ambiguities and you have to take them into account. There is an
utility written in IDL that, given an inverted map, obtains all the
other solutions which are ambiguous in the saturation regime. This can
be called, including the appropriate paths and discarding the final
<code class="docutils literal"><span class="pre">.nc</span></code> extension, by:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">IDL</span><span class="o">&gt;</span> <span class="n">disamb</span><span class="p">,</span> <span class="s1">&#39;file_with_inversions&#39;</span><span class="p">,</span> <span class="s1">&#39;file_with_observations&#39;</span><span class="p">,</span> <span class="n">angleObs</span>
</pre></div>
</div>
<p>where <code class="docutils literal"><span class="pre">angleObs</span></code> is the observation angle <span class="math">\(\theta\)</span> (so that it
is 90<span class="math">\(^\circ\)</span> for an observation exactly at the limb. This
program can be called with the additional <code class="docutils literal"><span class="pre">/gen_files_inversion</span></code>,
which then generates a set of observations, configuration files and a
file to run . This is useful in case the line is not in the saturation
regime. In this case, the ambiguous solutions that are found by the code
are not strictly valid and one should refine them with a final LM cycle
in which <span class="math">\(B\)</span>, <span class="math">\(\theta_B\)</span> and <span class="math">\(\chi_B\)</span> are left free.
The solution to the ambiguities in the saturation regime is shown in
Section [sec:ambiguities].</p>
</div>
</div>
<div class="section" id="calling-hazel-from-python">
<h1>Calling Hazel from Python<a class="headerlink" href="#calling-hazel-from-python" title="Permalink to this headline">¶</a></h1>
<p>We have developed a wrapper to allow the user to call the synthesis
routines of Hazel in Python. To do so, just enter into the directory
<code class="docutils literal"><span class="pre">SourcePy</span></code> and type</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">build_ext</span> <span class="o">--</span><span class="n">inplace</span>
</pre></div>
</div>
<p>and a library <code class="docutils literal"><span class="pre">pyhazel.so</span></code> will be generated (and also copied to the
directory <code class="docutils literal"><span class="pre">RunPy</span></code>. In this very same directory you can see the
<code class="docutils literal"><span class="pre">test.py</span></code> file that shows how to call the code to wrapper.</p>
</div>
<div class="section" id="basic-equations">
<h1>Basic Equations<a class="headerlink" href="#basic-equations" title="Permalink to this headline">¶</a></h1>
<p>We consider a constant-property slab of atoms, located at a height
<span class="math">\(h\)</span> above the visible solar “surface&#8221;, in the presence of a
deterministic magnetic field of arbitrary strength <span class="math">\(B\)</span>,
inclination <span class="math">\(\theta_B\)</span> and azimuth <span class="math">\(\chi_B\)</span> (see Fig. 1).
The slab’s optical thickness at the wavelength and line of sight under
consideration is <span class="math">\(\tau\)</span>. We assume that all the atoms inside this
slab are illuminated from below by the photospheric solar continuum
radiation field, whose center-to-limb variation has been tabulated by
<a href="#id4"><span class="problematic" id="id5">:raw-latex:`\cite{pierce00}`</span></a>. The ensuing anisotropic radiation pumping
produces population imbalances and quantum coherences between pairs of
magnetic sublevels, even among those pertaining to the different
<span class="math">\(J\)</span>-levels of the adopted atomic model. This atomic level
polarization and the Zeeman-induced wavelength shifts between the
<span class="math">\(\pi\)</span> (<span class="math">\(\Delta{M}=M_u-M_l=0\)</span>), <span class="math">\(\sigma_{\rm blue}\)</span>
(<span class="math">\(\Delta{M}=+1\)</span>) and <span class="math">\(\sigma_{\rm red}\)</span>
(<span class="math">\(\Delta{M}=-1\)</span>) transitions produce polarization in the emergent
spectral line radiation.</p>
<p>In order to facilitate the understanding of the code, in the following
we summarize the basic equations which allow us to calculate the
spectral line polarization taking rigorously into account the joint
action of atomic level polarization and the Hanle and Zeeman effects. To
this end, we have applied the quantum theory of spectral line
polarization, which is described in great detail in the monograph by
<a href="#id6"><span class="problematic" id="id7">:raw-latex:`\cite{landi_landolfi04}`</span></a>. We have also applied several
methods of solution of the Stokes-vector transfer equation, some of
which can be considered as particular cases of the two general methods
explained in §6 of <a href="#id8"><span class="problematic" id="id9">:raw-latex:`\cite{trujillo03}`</span></a>.</p>
<div class="section" id="the-radiative-transfer-approach">
<h2>The radiative transfer approach<a class="headerlink" href="#the-radiative-transfer-approach" title="Permalink to this headline">¶</a></h2>
<p>The emergent Stokes vector
<span class="math">\(\mathbf{I}(\nu,\mathbf{\Omega})=(I,Q,U,V)^{\dag}\)</span> (with
<span class="math">\(\dag\)</span>=transpose, <span class="math">\(\nu\)</span> the frequency and
<span class="math">\(\mathbf{\Omega}\)</span> the unit vector indicating the direction of
propagation of the ray) is obtained by solving the radiative transfer
equation</p>
<div class="math">
\[\frac{d}{ds}\mathbf{I}(\nu,\mathbf{\Omega}) =
\bm{\epsilon}(\nu,\mathbf{\Omega}) - \mathbf{K}(\nu,\mathbf{\Omega})
\mathbf{I}(\nu,\mathbf{\Omega}),
\label{eq:rad_transfer}\]</div>
<p>where <span class="math">\(s\)</span> is the geometrical distance along the ray under
consideration,
<span class="math">\(\bm{\epsilon}(\nu,\mathbf{\Omega})=({\epsilon}_I,{\epsilon}_Q,{\epsilon
}_U,{\epsilon}_V)^{\dag}\)</span> is the emission vector and</p>
<div class="math">
\[ \begin{align}\begin{aligned}\begin{split}  \mathbf{K} = \left( \begin{array}{cccc}
  \eta_I &amp; \eta_Q &amp; \eta_U &amp; \eta_V \\
  \eta_Q &amp; \eta_I &amp; \rho_V &amp; -\rho_U \\
  \eta_U &amp; -\rho_V &amp; \eta_I &amp; \rho_Q \\
  \eta_V &amp; \rho_U &amp; -\rho_Q &amp; \eta_I
  \end{array} \right)
  \label{eq:propagation}\end{split}\\is the propagation matrix. Alternatively, introducing the optical\end{aligned}\end{align} \]</div>
<p>distance along the ray, <span class="math">\({\rm d}{\tau}=-{\eta_I}{\rm d}s\)</span>, one can
write the Stokes-vector transfer Eq. ([eq:rad_transfer]) in the
following two ways:</p>
<ul>
<li><p class="first">The first one, whose formal solution requires the use of the
evolution operator introduced by <a href="#id10"><span class="problematic" id="id11">:raw-latex:`\cite{landi_landi85}`</span></a>,
is</p>
<div class="math">
\[ \begin{align}\begin{aligned}  {{d}\over{d{\tau}}}{\bf I}\,=\,{\bf K}^{*}
  {\bf I}\,-\,{\bf S},
  \label{eq:rad_transfer_peo}\\where :math:`{\bf K}^{*}={\bf K}/{\eta_I}` and\end{aligned}\end{align} \]</div>
<p><span class="math">\({\bf S}=\bm{\epsilon}/{\eta_I}\)</span>. The formal solution of this
equation can be seen in eq. (23) of <a href="#id12"><span class="problematic" id="id13">:raw-latex:`\cite{trujillo03}`</span></a>.</p>
</li>
<li><p class="first">The second one, whose formal solution does not require the use of the
above-mentioned evolution operator is
<a href="#id14"><span class="problematic" id="id15">:raw-latex:`\citep[e.g.,][]{rees_delo89}`</span></a></p>
<div class="math">
\[ \begin{align}\begin{aligned}  {{d}\over{d{\tau}}}{\bf I}\,=\,{\bf I}\,-\,{\bf S}_{\rm eff},
  \label{eq:rad_transfer_delo}\\where the effective source-function vector\end{aligned}\end{align} \]</div>
<p><span class="math">\(\,{\bf S}_{\rm eff}\,=\,{\bf S}\,-\,
{\bf K}^{'}{\bf I},\,\,\,\)</span> being
<span class="math">\(\,{\bf K}^{'}={\bf K}^{*}-{\bf 1}\)</span> (with <span class="math">\(\bf 1\)</span> the
unit matrix). The formal solution of this equation can be seen in eq.
(26) of <a href="#id16"><span class="problematic" id="id17">:raw-latex:`\cite{trujillo03}`</span></a>.</p>
</li>
</ul>
<p>Once the coefficients <span class="math">\(\epsilon_I\)</span> and <span class="math">\(\epsilon_X\)</span> (with
<span class="math">\(X=Q,U,V\)</span>) of the emission vector and the coefficients
<span class="math">\(\eta_I\)</span>, <span class="math">\(\eta_X\)</span>, and <span class="math">\(\rho_X\)</span> of the
<span class="math">\(4\times4\)</span> propagation matrix are known at each point within the
medium it is possible to solve formally Eq. ([eq:rad_transfer_peo]) or
Eq. ([eq:rad_transfer_delo]) for obtaining the emergent Stokes
profiles for any desired line of sight. Our computer program considers
the following levels of sophistication for the solution of the radiative
transfer equation:</p>
<ul>
<li><p class="first"><em>Numerical Solutions</em>. The most general case, where the properties of
the slab vary along the ray path, has to be solved numerically. To
this end, two efficient and accurate methods of solution of the
Stokes-vector transfer equation are those proposed by
<a href="#id18"><span class="problematic" id="id19">:raw-latex:`\cite{trujillo03}`</span></a> (see his eqs. (24) and (27),
respectively). The starting points for the development of these two
numerical methods were Eq. ([eq:rad_transfer_peo]) and Eq.
([eq:rad_transfer_delo]), respectively. Both methods can be
considered as generalizations, to the Stokes-vector transfer case, of
the well-known short characteristics method for the solution of the
standard (scalar) transfer equation.</p>
</li>
<li><p class="first"><em>Exact analytical solution of the problem of a constant-property slab
including the magneto-optical terms of the propagation matrix</em>. For
the general case of a constant-property slab of arbitrary optical
thickness we actually have the following analytical solution, which
can be easily obtained as a particular case of eq. (24) of
<a href="#id20"><span class="problematic" id="id21">:raw-latex:`\cite{trujillo03}`</span></a>:</p>
<div class="math">
\[{\bf I}={\rm e}^{-{\mathbf{K}^{*}}\tau}\,{\bf I}_{\rm sun}\,+\,\left[{\mathbf{K}^{*}}\right]^{-1}\,
\left( \mathbf{1} - {\rm e}^{-{\mathbf{K}^{*}}\tau} \right) \,\mathbf{S},
\label{eq:slab_peo}\]</div>
<p>where <span class="math">\(\mathbf{I}_{\rm sun}\)</span> is the Stokes vector that
illuminates the slab’s boundary that is most distant from the
observer. We point out that the exponential of the propagation matrix
<span class="math">\({\mathbf{K}^{*}}\)</span> has an analytical expression similar to eq.
(8.23) in <a href="#id22"><span class="problematic" id="id23">:raw-latex:`\cite{landi_landolfi04}`</span></a>.</p>
</li>
<li><p class="first"><em>Approximate analytical solution of the problem of a
constant-property slab including the magneto-optical terms of the
propagation matrix</em>. An approximate analytical solution to the
constant-property slab problem can be easily obtained as a particular
case of eq. (27) of <a href="#id24"><span class="problematic" id="id25">:raw-latex:`\cite{trujillo03}`</span></a>:</p>
<div class="math">
\[\mathbf{I} = \left[ \mathbf{1}+\Psi_0 \mathbf{K}' \right]^{-1} \left[ \left(
e^{-\tau} \mathbf{1} - \Psi_M \mathbf{K}' \right) \mathbf{I}_{\rm sun} +
(\Psi_M+\Psi_0) \mathbf{S} \right],
\label{eq:slab_delo}\]</div>
<p>where the coefficients <span class="math">\(\Psi_M\)</span> and <span class="math">\(\Psi_0\)</span> depend only
on the optical thickness of the slab at the frequency and
line-of-sight under consideration, since their expressions are:</p>
<div class="math">
\[\begin{split}\begin{aligned}
\Psi_M&amp;=&amp; \frac{1-e^{-\tau}}{\tau} - e^{-\tau},\nonumber \\
\Psi_0 &amp;=&amp;1-\frac{1-e^{-\tau}}{\tau}.\end{aligned}\end{split}\]</div>
<p>Note that Eq. ([eq:slab_delo]) for the emergent Stokes vector is the
one used by <a href="#id26"><span class="problematic" id="id27">:raw-latex:`\cite{trujillo_asensio07}`</span></a> for investigating
the impact of atomic level polarization on the Stokes profiles of the
He i 10830 Å&nbsp;multiplet. We point out that, strictly speaking, it can
be considered only as the exact analytical solution of the
optically-thin constant-property slab problem <a class="footnote-reference" href="#id70" id="id28">[3]</a>. The reason why
Eq. ([eq:slab_delo]) is, in general, an approximate expression for
calculating the emergent Stokes vector is because its derivation
assumes that the Stokes vector within the slab varies linearly with
the optical distance. However, it provides a fairly good
approximation to the emergent Stokes profiles (at least for all the
problems we have investigated in this paper). Moreover, the results
of fig. 2 of <a href="#id29"><span class="problematic" id="id30">:raw-latex:`\cite{trujillo_asensio07}`</span></a> remain also
virtually the same when using instead the exact Eq. ([eq:slab_peo]),
which from a computational viewpoint is significantly less efficient
than the approximate Eq. ([eq:slab_delo]).</p>
</li>
<li><p class="first"><em>Exact analytical solution of the problem of a constant-property slab
when neglecting the second-order terms of the Stokes-vector transfer
equation</em>. Simplified expressions for the emergent Stokes vector can
be obtained when <span class="math">\(\epsilon_I{\gg}\epsilon_X\)</span> and
<span class="math">\(\eta_I{\gg}(\eta_X,\rho_X)\)</span>, which justifies to neglect the
second-order terms of Eq. ([eq:rad_transfer]). The resulting
approximate formulae for the emergent Stokes parameters are given by
eqs. (9) and (10) of <a href="#id31"><span class="problematic" id="id32">:raw-latex:`\cite{trujillo_asensio07}`</span></a>, which
are identical to those used by <a href="#id33"><span class="problematic" id="id34">:raw-latex:`\cite{trujillo_merenda05}`</span></a>
for modeling the Stokes profiles observed in solar chromospheric
spicules. We point out that there is a typing error in the sentence
that introduces such eqs. (9) and (10) in
<a href="#id35"><span class="problematic" id="id36">:raw-latex:`\cite{trujillo_asensio07}`</span></a>, since they are obtained only
when the above-mentioned second-order terms are neglected in Eq.
([eq:rad_transfer]), although it is true that there are no
magneto-optical terms in the resulting equations.</p>
</li>
<li><p class="first"><em>Optically thin limit</em>. Finally, the most simple solution is obtained
when taking the optically thin limit (<span class="math">\(\tau{\ll}1\)</span>) in the
equations reported in the previous point, which lead to the equations
(11) and (12) of <a href="#id37"><span class="problematic" id="id38">:raw-latex:`\cite{trujillo_asensio07}`</span></a>. Note that if
<span class="math">\(\mathbf{I}_{\rm sun}=0\)</span> (i.e., <span class="math">\(I_0=X_0=0\)</span>), then such
optically thin equations imply that
<span class="math">\({X/I}\,{\approx}\,{\epsilon_X}/{\epsilon_I}\)</span>.</p>
</li>
</ul>
<p>The coefficients of the emission vector and of the propagation matrix
depend on the multipolar components, <span class="math">\(\rho^K_Q(J,J^{'})\)</span>, of the
atomic density matrix. Let us recall now the meaning of these physical
quantities and how to calculate them in the presence of an arbitrary
magnetic field under given illumination conditions.</p>
</div>
<div class="section" id="the-multipolar-components-of-the-atomic-density-matrix">
<h2>The multipolar components of the atomic density matrix<a class="headerlink" href="#the-multipolar-components-of-the-atomic-density-matrix" title="Permalink to this headline">¶</a></h2>
<p>We quantify the atomic polarization of the atomic levels using the
multipolar components of the atomic density matrix. We assume that the
atom can be correctly described under the framework of the
<span class="math">\(L\)</span>-<span class="math">\(S\)</span> coupling
<a href="#id39"><span class="problematic" id="id40">:raw-latex:`\citep[e.g.,][]{condon_shortley35}`</span></a>. The different
<span class="math">\(J\)</span>-levels are grouped in terms with well defined values of the
electronic angular momentum <span class="math">\(L\)</span> and the spin <span class="math">\(S\)</span>. We neglect
the influence of hyperfine structure and assume that the energy
separation between the <span class="math">\(J\)</span>-levels pertaining to each term is very
small in comparison with the energy difference between different terms.
Therefore, we allow for coherences between different <span class="math">\(J\)</span>-levels
pertaining to the same term but not between the <span class="math">\(J\)</span>-levels
pertaining to different terms. As a result, we can represent the atom
under the formalism of the multi-term atom discussed by
<a href="#id41"><span class="problematic" id="id42">:raw-latex:`\cite{landi_landolfi04}`</span></a>.</p>
<p>In the absence of magnetic fields the energy eigenvectors can be written
using Dirac’s notation as <span class="math">\(|\beta L S J M\rangle\)</span>, where
<span class="math">\(\beta\)</span> indicates a set of inner quantum numbers specifying the
electronic configuration. In general, if a magnetic field of arbitrary
strength is present, the vectors <span class="math">\(|\beta L S J M\rangle\)</span> are no
longer eigenfunctions of the total Hamiltonian and <span class="math">\(J\)</span> is no
longer a good quantum number. In this case, the eigenfunctions of the
full Hamiltonian can be written as the following linear combination:</p>
<div class="math">
\[ \begin{align}\begin{aligned}  \label{eq:eigenfunctions_total_hamiltonian}
  |\beta L S j M\rangle = \sum_J C_J^j(\beta L S, M) |\beta L S J M\rangle,\\where :math:`j` is a pseudo-quantum number which is used for labeling\end{aligned}\end{align} \]</div>
<p>the energy eigenstates belonging to the subspace corresponding to
assigned values of the quantum numbers <span class="math">\(\beta\)</span>, <span class="math">\(L\)</span>,
<span class="math">\(S\)</span>, and <span class="math">\(M\)</span>, and where the coefficients <span class="math">\(C_J^j\)</span> can
be chosen to be real.</p>
<p>In the presence of a magnetic field sufficiently weak so that the
magnetic energy is much smaller than the energy intervals between the
<span class="math">\(J\)</span>-levels, the energy eigenvectors are still of the form
<span class="math">\(|\beta L S J M\rangle\)</span>
(<span class="math">\(C_J^j(\beta L S, M) \approx \delta_{Jj}\)</span>), and the splitting of
the magnetic sublevels pertaining to each <span class="math">\(J\)</span>-level is linear with
the magnetic field strength. For stronger magnetic fields, we enter the
incomplete Paschen-Back effect regime in which the energy eigenvectors
are of the general form given by Eq.
([eq:eigenfunctions_total_hamiltonian]), and the splitting among the
various <span class="math">\(M\)</span>-sublevels is no longer linear with the magnetic
strength. If the magnetic field strength is further increased we
eventually reach the so-called complete Paschen-Back effect regime,
where the energy eigenvectors are of the form
<span class="math">\(|L S M_L M_S\rangle\)</span> and each <span class="math">\(L\)</span>-<span class="math">\(S\)</span> term splits
into a number of components, each of which corresponding to particular
values of (<span class="math">\(M_L+2M_S\)</span>).</p>
<p>Within the framework of the multi-term atom model the atomic
polarization of the energy levels is described with the aid of the
density matrix elements</p>
<div class="math">
\[ \begin{align}\begin{aligned}\rho^{\beta L S}(jM,j'M') = \langle \beta L S j M | \rho | \beta L S j' M'\rangle,\\where :math:`\rho` is the atomic density matrix operator. Using the\end{aligned}\end{align} \]</div>
<p>expression of the eigenfunctions of the total Hamiltonian given by Eq.
([eq:eigenfunctions_total_hamiltonian]), the density matrix elements
can be rewritten as:</p>
<div class="math">
\[ \begin{align}\begin{aligned}  \rho^{\beta L S}(jM,j'M') = \sum_{JJ'} C_J^j(\beta L S, M) C_{J'}^{j'}(\beta L
  S, M') \rho^{\beta L S}(JM,J'M'),\\where :math:`\rho^{\beta L S}(JM,J'M')` are the density matrix elements\end{aligned}\end{align} \]</div>
<p>on the basis of the eigenvectors <span class="math">\(| \beta L S J M\rangle\)</span>.</p>
<p>Following <a href="#id43"><span class="problematic" id="id44">:raw-latex:`\cite{landi_landolfi04}`</span></a>, it is helpful to use the
spherical statistical tensor representation, which is related to the
previous one by the following linear combination:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\begin{split}  \begin{aligned}
  {^{\beta LS}\rho^K_Q(J,J')} &amp;=&amp; \sum_{jj'MM'} C_J^j(\beta L S, M)
  C_{J'}^{j'}(\beta L S, M') \nonumber \\
  &amp;\times&amp; (-1)^{J-M} \sqrt{2K+1} { \left(\begin{array}{ccc}
  J&amp;J'&amp;K\\
  M&amp;-M'&amp;-Q
  \end{array}\right) }
  \rho^{\beta L S}(jM,j'M'),\end{aligned}\end{split}\\where the 3-j symbol is defined as indicated by any suitable textbook\end{aligned}\end{align} \]</div>
<p>on Racah algebra.</p>
</div>
<div class="section" id="statistical-equilibrium-equations">
<h2>Statistical equilibrium equations<a class="headerlink" href="#statistical-equilibrium-equations" title="Permalink to this headline">¶</a></h2>
<p>In order to obtain the <span class="math">\({^{\beta LS}\rho^K_Q(J,J')}\)</span> elements we
have to solve the statistical equilibrium equations. These equations,
written in a reference system in which the quantization axis (<span class="math">\(Z\)</span>)
is directed along the magnetic field vector and neglecting the influence
of collisions, can be written as <a href="#id45"><span class="problematic" id="id46">:raw-latex:`\citep{landi_landolfi04}`</span></a>:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\begin{split}  \begin{aligned}
  \frac{d}{dt} {^{\beta LS}\rho^K_Q(J,J')} &amp;=&amp; -2\pi \mathrm{i} \sum_{K' Q'}
  \sum_{J'' J'''} N_{\beta LS}(KQJJ',K'Q'J''J''') {^{\beta LS}\rho^{K'}_{Q'}(J'',J''')}
  \nonumber \\
  &amp;+&amp; \sum_{\beta_\ell L_\ell K_\ell Q_\ell J_\ell J_\ell'} {^{\beta_\ell L_\ell
  S}\rho^{K_\ell}_{Q_\ell}(J_\ell,J_\ell')}
  \mathbb{T}_A(\beta L S K Q J J', \beta_\ell L_\ell S K_\ell Q_\ell J_\ell
  J_\ell') \nonumber \\
  &amp;+&amp; \sum_{\beta_u L_u K_u Q_u J_u J_u'} {^{\beta_u L_u
  S}\rho^{K_u}_{Q_u}(J_u,J_u')}
  \Big[ \mathbb{T}_E(\beta L S K Q J J', \beta_u L_u S K_u Q_u J_u J_u') \nonumber \\
  &amp; &amp;\qquad \qquad \qquad \qquad \qquad + \mathbb{T}_S(\beta L S K Q
  J J', \beta_u L_u S K_u Q_u J_u J_u') \Big] \nonumber \\
  &amp;-&amp; \sum_{K' Q' J'' J'''} {^{\beta L S}\rho^{K'}_{Q'}(J'',J''') } \Big[
  \mathbb{R}_A(\beta L S K Q J J' K' Q' J'' J''') \nonumber \\
  &amp; &amp; + \mathbb{R}_E(\beta L S K Q J J' K'
  Q' J'' J''') + \mathbb{R}_S(\beta L S K Q J J' K' Q' J'' J''') \Big].
  \label{eq:see}\end{aligned}\end{split}\\The first term in the right hand side of Eq. ([eq:see]) takes into\end{aligned}\end{align} \]</div>
<p>account the influence of the magnetic field on the atomic level
polarization. This term has its simplest expression in the chosen
magnetic field reference frame
<a href="#id47"><span class="problematic" id="id48">:raw-latex:`\citep[see eq. 7.41 of][]{landi_landolfi04}`</span></a>. In any other
reference system, a more complicated expression arises. The second,
third and fourth terms account, respectively, for coherence transfer due
to absorption from lower levels (<span class="math">\(\mathbb{T}_A\)</span>), spontaneous
emission from upper levels (<span class="math">\(\mathbb{T}_E\)</span>) and stimulated
emission from upper levels (<span class="math">\(\mathbb{T}_S\)</span>). The remaining terms
account for the relaxation of coherences due to absorption to upper
levels (<span class="math">\(\mathbb{R}_A\)</span>), spontaneous emission to lower levels
(<span class="math">\(\mathbb{R}_E\)</span>) and stimulated emission to lower levels
(<span class="math">\(\mathbb{R}_S\)</span>), respectively.</p>
<p>The stimulated emission and absorption transfer and relaxation rates
depend explicitly on the radiation field properties
<a href="#id49"><span class="problematic" id="id50">:raw-latex:`\citep[see eqs. 7.45 and 7.46 of][]{landi_landolfi04}`</span></a>. The
symmetry properties of the radiation field are accounted for by the
spherical components of the radiation field tensor:</p>
<div class="math">
\[J^K_Q(\nu) = \oint \frac{d\Omega}{4\pi} \sum_{i=0}^3
\mathcal{T}^K_Q(i,\mathbf{\Omega}) S_i(\nu,\mathbf{\Omega}).
\label{eq:jkq}\]</div>
<p>The quantities <span class="math">\(\mathcal{T}^K_Q(i,\mathbf{\Omega})\)</span> are spherical
tensors that depend on the reference frame and on the ray direction
<span class="math">\(\mathbf{\Omega}\)</span>. They are given by</p>
<div class="math">
\[ \begin{align}\begin{aligned}  \mathcal{T}^K_Q(i,\mathbf{\Omega}) = \sum_P t^K_P(i) \mathcal{D}^K_{PQ}(R'),
  \label{eq:tkq}\\where :math:`R'` is the rotation that carries the reference system\end{aligned}\end{align} \]</div>
<p>defined by the line-of-sight <span class="math">\(\mathbf{\Omega}\)</span> and by the
polarization unit vectors <span class="math">\(\mathbf{e}_1\)</span> and <span class="math">\(\mathbf{e}_2\)</span>
into the reference system of the magnetic field, while
<span class="math">\(\mathcal{D}^K_{PQ}(R')\)</span> is the usual rotation matrix
<a href="#id51"><span class="problematic" id="id52">:raw-latex:`\citep[e.g.,][]{edmonds60}`</span></a>. Table 5.6 in
<a href="#id53"><span class="problematic" id="id54">:raw-latex:`\cite{landi_landolfi04}`</span></a> gives the
<span class="math">\(\mathcal{T}^K_Q(i,\mathbf{\Omega})\)</span> values for each Stokes
parameter <span class="math">\(S_i\)</span> (with <span class="math">\(S_0=I\)</span>, <span class="math">\(S_1=Q\)</span>, <span class="math">\(S_2=U\)</span>
and <span class="math">\(S_3=V\)</span>).</p>
</div>
<div class="section" id="emission-and-absorption-coefficients">
<h2>Emission and absorption coefficients<a class="headerlink" href="#emission-and-absorption-coefficients" title="Permalink to this headline">¶</a></h2>
<p>Once the multipolar components <span class="math">\({^{\beta L S}\rho^{K}_{Q}(J,J') }\)</span>
are known, the coefficients <span class="math">\(\epsilon_I\)</span> and <span class="math">\(\epsilon_X\)</span>
(with <span class="math">\(X=Q,U,V\)</span>) of the emission vector and the coefficients
<span class="math">\(\eta_I\)</span>, <span class="math">\(\eta_X\)</span>, and <span class="math">\(\rho_X\)</span> of the propagation
matrix for a given transition between an upper term
<span class="math">\((\beta L_u S)\)</span> and an lower term <span class="math">\((\beta L_\ell S)\)</span> can be
calculated with the expressions of §7.6.b in
<a href="#id55"><span class="problematic" id="id56">:raw-latex:`\cite{landi_landolfi04}`</span></a>. These radiative transfer
coefficients are proportional to the number density of atoms,
<span class="math">\(\mathcal{N}\)</span>. Their defining expressions contain also the Voigt
profile and the Faraday-Voigt profile
<a href="#id57"><span class="problematic" id="id58">:raw-latex:`\citep[see \S5.4 in][]{landi_landolfi04}`</span></a>, which involve the
following parameters: <span class="math">\(a\)</span> (i.e., the reduced damping constant),
<span class="math">\(v_\mathrm{th}\)</span> (i.e., the velocity that characterizes the thermal
motions, which broaden the line profiles), and <span class="math">\(v_\mathrm{mac}\)</span>
(i.e., the velocity of possible bulk motions in the plasma, which
produce a Doppler shift).</p>
<p>It is important to emphasize that the expressions for the emission and
absorption coefficients and those of the statistical equilibrium
equations are written in the reference system whose quantization axis is
parallel to the magnetic field. The following equation indicates how to
obtain the density matrix elements in a new reference system:</p>
<div class="math">
\[ \begin{align}\begin{aligned}  \left[ {^{\beta L S}\rho^{K}_{Q}(J,J') } \right]_\mathrm{new} = \sum_{Q'} \left[
  {^{\beta L S}\rho^{K}_{Q'}(J,J') } \right]_\mathrm{old}
  \mathcal{D}^K_{Q' Q}(R)^*,\\where :math:`\mathcal{D}^K_{Q' Q}(R)^*` is the complex conjugate of the\end{aligned}\end{align} \]</div>
<p>rotation matrix for the rotation <span class="math">\(R\)</span> that carries the old
reference system into the new one.</p>
</div>
</div>
<div class="section" id="inversion">
<h1>Inversion<a class="headerlink" href="#inversion" title="Permalink to this headline">¶</a></h1>
<p>Our inversion strategy is based on the minimization of a merit function
that quantifies how well the Stokes profiles calculated in our
atmospheric model reproduce the observed Stokes profiles. To this end,
we have chosen the standard <span class="math">\(\chi^2\)</span>–function, defined as:</p>
<div class="math">
\[ \begin{align}\begin{aligned}  \chi^2 = \frac{1}{4N_\lambda} \sum_{i=1}^4 \sum_{j=1}^{N_\lambda}
  \frac{\left[S_i^\mathrm{syn}(\lambda_j)-S_i^\mathrm{obs}(\lambda_j) \right]^2}{
  \sigma_i^2(\lambda_j)} ,\\where :math:`N_\lambda` is the number of wavelength points and\end{aligned}\end{align} \]</div>
<p><span class="math">\(\sigma_i^2(\lambda_j)\)</span> is the variance associated to the
<span class="math">\(j\)</span>-th wavelength point of the <span class="math">\(i\)</span>-th Stokes profiles. The
minimization algorithm tries to find the value of the parameters of our
model that lead to synthetic Stokes profiles <span class="math">\(S_i^\mathrm{syn}\)</span>
with the best possible fit to the observations. For our slab model, the
number of parameters (number of dimensions of the <span class="math">\(\chi^2\)</span>
hypersurface) lies between 5 and 7, the maximum value corresponding to
the optically thick case. The magnetic field vector (<span class="math">\(B\)</span>,
<span class="math">\(\theta_B\)</span> and <span class="math">\(\chi_B\)</span>), the thermal velocity
(<span class="math">\(v_\mathrm{th}\)</span>) and the macroscopic velocity
(<span class="math">\(v_\mathrm{mac}\)</span>) are always required. This set of parameters is
enough for the case of an optically thin slab. In order to account for
radiative transfer effects, we need to define the optical depth of the
slab along its normal direction and at a suitable reference wavelength
(e.g., the central wavelength of the red blended component for the 10830
Å&nbsp;multiplet). In addition, we may additionally need to include the
damping parameter (<span class="math">\(a\)</span>) of the Voigt profile if the wings of the
observed Stokes profiles cannot be fitted using Gaussian line profiles.</p>
<div class="section" id="global-optimization-techniques">
<h2>Global Optimization techniques<a class="headerlink" href="#global-optimization-techniques" title="Permalink to this headline">¶</a></h2>
<p>In order to avoid the possibility of getting trapped in a local minimum
of the <span class="math">\(\chi^2\)</span> hypersurface, global optimization methods have to
be used. We have chosen the DIRECT algorithm
<a href="#id59"><span class="problematic" id="id60">:raw-latex:`\citep{Jones_DIRECT93}`</span></a>, whose name derives from one of its
main features: <em>di</em>viding <em>rect</em>angles. The idea is to recursively
sample parts of the space of parameters, improving in each iteration the
location of the part of the space where the global minimum is
potentially located. The decision algorithm is based on the assumption
that the function is Lipschitz continuous
<a href="#id61"><span class="problematic" id="id62">:raw-latex:`\citep[see][for details]{Jones_DIRECT93}`</span></a>. The method works
very well in practice and can indeed find the minimum in functions that
do not fulfill the condition of Lipschitz continuity. The reason is that
the DIRECT algorithm does not require the explicit calculation of the
Lipschitz constant but it uses all possible values of such a constant to
determine if a region of the parameter space should be broken into
subregions because of its potential interest
<a href="#id63"><span class="problematic" id="id64">:raw-latex:`\citep[see][for details]{Jones_DIRECT93}`</span></a>.</p>
<p>Since the intensity profile is not very sensitive to the presence of a
magnetic field (at least for magnetic field strengths of the order of or
smaller than 1000 G), we have decided to estimate the optical thickness
of the slab, the thermal and the macroscopic velocity of the plasma and
the damping constant by using only the Stokes <span class="math">\(I\)</span> profile, and
then to determine the magnetic field vector by using the polarization
profiles. The full inversion scheme begins by applying the DIRECT method
to obtain a first estimation of the indicated four parameters by using
only Stokes <span class="math">\(I\)</span>. Afterwards, some LM iterations are carried out to
refine the initial values of the model’s parameters obtained in the
previous step. Once the LM method has converged, the inferred values of
<span class="math">\(v_\mathrm{th}\)</span>, <span class="math">\(v_\mathrm{mac}\)</span> (together with <span class="math">\(a\)</span>
and <span class="math">\(\Delta \tau\)</span>, when these are parameters of the model) are
kept fixed in the next steps, in which the DIRECT method is used again
for obtaining an initial approximation of the magnetic field vector
(<span class="math">\(B\)</span>,<span class="math">\(\theta_B\)</span>,<span class="math">\(\chi_B\)</span>). According to our
experience, the first estimate of the magnetic field vector given by the
DIRECT algorithm is typically very close to the final solution.
Nevertheless, some iterations of the LM method are performed to refine
the value of the magnetic field strength, inclination and azimuth. In
any case, although we have found very good results with this procedure,
the specific inversion scheme is fully configurable and can be tuned for
specific problems.</p>
<p>Our experience has proved that the following strategy is appropriate for
inverting prominences. Two initial DIRECT+LM cycles with weights
<span class="math">\((1,0,0,0)\)</span> to invert the thermodynamical parameters. Then, two
DIRECT+LM cycles in which <span class="math">\(B\)</span>, <span class="math">\(\theta_B\)</span> and <span class="math">\(\chi_B\)</span>
are left free with weights <span class="math">\((0,0.1,0.1,1)\)</span> which tries to set the
correct polarity of the field given by Stokes <span class="math">\(V\)</span>. An additional
LM cycle in which we fit only <span class="math">\(\theta_B\)</span> and <span class="math">\(\chi_B\)</span> with
the weights <span class="math">\((0,1,1,0.3)\)</span> and a last LM cycle with weights
<span class="math">\((0,0.3,0.3,1)\)</span> leaving the full magnetic field vector free.</p>
</div>
<div class="section" id="convergence">
<h2>Convergence<a class="headerlink" href="#convergence" title="Permalink to this headline">¶</a></h2>
<p>We let the DIRECT algorithm locate the global minimum in a region whose
hypervolume is <span class="math">\(V\)</span>. This hypervolume is obtained as the product of
the length <span class="math">\(d_i\)</span> of each dimension associated with each of the
<span class="math">\(N\)</span> parameters:</p>
<div class="math">
\[ \begin{align}\begin{aligned}V = \prod_i^N d_i.\\When the hypervolume decreases by a factor :math:`f` after the DIRECT\end{aligned}\end{align} \]</div>
<p>algorithm has discarded some of the hyperrectangles, its size along each
dimension is approximately decreased by a factor <span class="math">\(f^{1/N}\)</span>. In
order to end up with a small region where the global minimum is located,
many subdivisions are necessary, thus requiring many function
evaluations.</p>
<p>The most time consuming part of any optimization procedure is the
evaluation of the merit function. The DIRECT algorithm needs only a
reduced number of evaluations of the merit function to find the region
where the global minimum is located. For this reason, we have chosen it
as the initialization part of the LM method. Since the initialization
point is close to the global minimum, the LM method, thanks to its
quadratic behavior, rapidly converges to the minimum.</p>
</div>
<div class="section" id="stopping-criterium">
<h2>Stopping criterium<a class="headerlink" href="#stopping-criterium" title="Permalink to this headline">¶</a></h2>
<p>We have used two stopping criteria for the DIRECT algorithm. The first
one is stopping when the ratio between the hypervolume where the global
minimum is located and the original hypervolume is smaller than a given
threshold. This method has been chosen when using the DIRECT algorithm
as an initialization for the LM method, giving very good results. The
other good option, suggested by <a href="#id65"><span class="problematic" id="id66">:raw-latex:`\cite{Jones_DIRECT93}`</span></a>, is
to stop after a fixed number of evaluations of the merit function.</p>
</div>
</div>
<div class="section" id="ambiguities-in-the-hanle-effect-in-the-saturation-regime">
<h1>Ambiguities in the Hanle effect in the saturation regime<a class="headerlink" href="#ambiguities-in-the-hanle-effect-in-the-saturation-regime" title="Permalink to this headline">¶</a></h1>
<p>In the saturation regime of the Hanle effect, Stokes <span class="math">\(Q\)</span> and
<span class="math">\(U\)</span> are insensitive to the field strength, but are sensitive to
the geometry of the field. For a <span class="math">\(J=0 \to J=1\)</span> transition, the
linear polarization can be written as:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\begin{split}  \begin{aligned}
  Q &amp;=&amp; \frac{q}{2} \left( 3 \cos^2 \theta_B-1 \right) \sin^2\Theta_B \cos 2\Phi_B \nonumber \\
  U &amp;=&amp; \frac{q}{2} \left( 3 \cos^2 \theta_B-1 \right) \sin^2\Theta_B \sin 2\Phi_B.\end{aligned}\end{split}\\These expressions contain a mixture of angles to make it clear that the\end{aligned}\end{align} \]</div>
<p>polarization amplitude depends on both the angle between the vertical
and the magnetic field and between the magnetic field and the
line-of-sight (LOS).</p>
<p>The coordinates of the magnetic field vector <span class="math">\(\mathbf{B}\)</span> in the
reference system of the vertical and the reference system of the LOS
are:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\begin{split}  \begin{aligned}
  \mathbf{B} &amp;=&amp; B \left(\sin \theta_B \cos \phi_B \mathbf{i}+\sin \theta_B \sin \phi_B \mathbf{j}+\cos \theta_B \mathbf{k} \right) \nonumber \\
  \mathbf{B} &amp;=&amp; B \left(\sin \Theta_B \cos \Phi_B \mathbf{i}'+\sin \Theta_B \sin \Phi_B \mathbf{j}'+\cos \Theta_B \mathbf{k}' \right),\end{aligned}\end{split}\\where the unit vectors are related by a simple rotation:\end{aligned}\end{align} \]</div>
<div class="math">
\[ \begin{align}\begin{aligned}\begin{split}  \begin{aligned}
  \mathbf{i}' &amp;=&amp; \cos \theta \mathbf{i} - \sin \theta \mathbf{k} \nonumber \\
  \mathbf{k}' &amp;=&amp; \sin \theta \mathbf{i} + \cos \theta \mathbf{k}.\end{aligned}\end{split}\\Introducing these relations on the expression for the magnetic field,\end{aligned}\end{align} \]</div>
<p>we find that the following has to be fulfilled, given that the magnetic
field vector is the same in both reference systems:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\begin{split}  \begin{aligned}
  \sin \theta_B \cos \phi_B &amp;=&amp; \sin \Theta_B \cos \Phi_B \cos \theta + \cos \Theta_B + \sin \theta \nonumber \\
  \sin \theta_B \sin \phi_B &amp;=&amp; \sin \Theta_B \sin \Phi_B \nonumber \\
  \cos \theta_B &amp;=&amp; \cos \Theta_B \cos \theta - \sin \Theta_B \cos \Phi_B \sin \theta.\end{aligned}\end{split}\\Solving the previous three equations in the two directions, we find the\end{aligned}\end{align} \]</div>
<p>following transformations between the angles in the vertical reference
system and the LOS reference system:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\begin{split}  \begin{aligned}
  \cos \Theta_B &amp;=&amp; \cos\theta \cos\theta_B + \sin\theta \sin\theta_B \cos\phi_B \nonumber \\
  \sin \Theta_B &amp;=&amp; +\sqrt{1-\cos^2\Theta_B} \nonumber \\
  \cos \Phi_B &amp;=&amp; \frac{\cos\theta \sin\theta_B \cos\phi_B - \cos\theta_B \sin\theta}{\sin \Theta_B} \nonumber \\
  \sin \Phi_B &amp;=&amp; \frac{\sin\theta_B \sin\phi_B}{\sin\Theta_B}\end{aligned}\end{split}\\and\end{aligned}\end{align} \]</div>
<div class="math">
\[ \begin{align}\begin{aligned}\begin{split}  \begin{aligned}
  \cos \theta_B &amp;=&amp; \cos\theta \cos\Theta_B - \sin\theta \sin\Theta_B \cos\Phi_B \nonumber \\
  \sin \theta_B &amp;=&amp; +\sqrt{1-\cos^2\theta_B} \nonumber \\
  \cos \phi_B &amp;=&amp; \frac{\cos\theta \sin\Theta_B \cos\Phi_B + \cos\Theta_B \sin\theta}{\sin \theta_B} \nonumber \\
  \sin \phi_B &amp;=&amp; \frac{\sin\Theta_B \sin\Phi_B}{\sin\theta_B}.\end{aligned}\end{split}\\Note that, since :math:`\Theta_B \in [0,\pi]`, we can safely use the\end{aligned}\end{align} \]</div>
<p>square root and take the positive value. In order to transform from one
reference system to the other, we can compute the inclination easily by
inverting the sinus or the cosinus. However, the situation is different
for the azimuth, because the range of variation is <span class="math">\([-\pi,\pi]\)</span>.
Therefore, one has to compute the cosinus and the sinus separately and
the decide which is the correct quadrant fo the angle in terms of the
signs of both quantities.</p>
<p>Four possible kinds of ambiguities can exist for the Stokes <span class="math">\(Q\)</span>
and <span class="math">\(U\)</span> parameters. The idea is that <span class="math">\(\Phi_B\)</span> can be
modified and still obtain the same <span class="math">\(Q\)</span> and <span class="math">\(U\)</span> by properly
adjusting the value of <span class="math">\(\Theta_B\)</span>. It is clear that, given that
the term that can be used to compensate for the change in the azimuth on
the LOS reference system is the same for Stokes <span class="math">\(Q\)</span> and <span class="math">\(U\)</span>,
we can only compensate for changes in the sign. Therefore, we have the
following potential ambiguities:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\begin{split}  \begin{aligned}
  \Phi_B' &amp;=&amp; \Phi_B \nonumber \\
  \Phi_B' &amp;=&amp; \Phi_B -\pi/2 \nonumber \\
  \Phi_B' &amp;=&amp; \Phi_B + \pi/2 \nonumber \\
  \Phi_B' &amp;=&amp; \Phi_B + \pi.\end{aligned}\end{split}\\For each case, we have to compute the value of :math:`\Theta_B'` that\end{aligned}\end{align} \]</div>
<p>keeps the value of <span class="math">\(Q\)</span> and <span class="math">\(U\)</span> unchanged. Therefore, once we
find a solution to the inversion problem in the form of the pair
<span class="math">\((\theta_B,\phi_B)\)</span>, we can find the remaining solutions in the
saturation regime following the recipes that we present now. Remember
that, unless one knows the polarity of the field, or in other words, the
sign <span class="math">\(\cos\Theta_B\)</span>, the number of potential ambiguous solutions
is 8. If the polarity of the field is known, the number is typically
reduced to 4 (or 2 if no 90<span class="math">\(^\circ\)</span> ambiguity is present).</p>
</div>
<div class="section" id="phib-phib">
<h1>PhiB’=PhiB<a class="headerlink" href="#phib-phib" title="Permalink to this headline">¶</a></h1>
<p>Under this change, we have that</p>
<div class="math">
\[ \begin{align}\begin{aligned}\cos 2\Phi_B' = \cos 2\Phi_B, \quad \sin 2\Phi_B' = \sin 2\Phi_B, \quad \cos \Phi_B' = \cos \Phi_B, \quad \sin \Phi_B' = \sin \Phi_B.\\Making use of the previous relations between the angles wrt to the\end{aligned}\end{align} \]</div>
<p>vertical and the LOS, we have to solve the following equation:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\left( 3 \cos^2\theta_B'-1 \right) \sin^2 \Theta_B' = \left( 3 \cos^2\theta_B-1 \right) \sin^2 \Theta_B,\\which can be written as:\end{aligned}\end{align} \]</div>
<div class="math">
\[ \begin{align}\begin{aligned}  \left[ 3 \left( \cos \Theta_B' \cos \theta - \sin\theta \sin\Theta_B' \cos\Phi_B\right)^2-1 \right] \sin^2 \Theta_B' =
  \left[ 3 \left( \cos \Theta_B \cos \theta - \sin\theta \sin\Theta_B \cos\Phi_B\right)^2-1 \right] \sin^2 \Theta_B.\\After some algebra and doing the substitution :math:`t=\sin\Theta_B'`,\end{aligned}\end{align} \]</div>
<p>we end up with the following equation to be solved:</p>
<div class="math">
\[ \begin{align}\begin{aligned}A t^4 + Bt^2 + C t^3 \sqrt{1-t^2} = K,\\where\end{aligned}\end{align} \]</div>
<div class="math">
\[ \begin{align}\begin{aligned}\begin{split}  \begin{aligned}
  A &amp;=&amp; -3\cos^2 \theta + 3\sin^2 \theta \cos^2 \Phi_B \nonumber \\
  B &amp;=&amp; 3\cos^2 \theta - 1 \nonumber \\
  C &amp;=&amp; -6 \cos\theta \sin\theta \cos \Phi_B \nonumber \\
  K &amp;=&amp; \left[ 3 \left( \cos \Theta_B \cos \theta - \sin\theta \sin\Theta_B \cos\Phi_B\right)^2-1 \right] \sin^2 \Theta_B.\end{aligned}\end{split}\\The previous equation can be solved if we make the change of variables\end{aligned}\end{align} \]</div>
<p><span class="math">\(t=\pm \sqrt{Z}\)</span>, resulting in:</p>
<div class="math">
\[ \begin{align}\begin{aligned}(C^2+A^2) Z^4 + (-C^2+2AB) Z^3 + (-2AK+B^2) Z^2 - 2BKZ + K^2 = 0.\\This polynomial of 4-th order can have four different solutions. From\end{aligned}\end{align} \]</div>
<p>these solutions, we have to take only the real solutions which are
larger than 0, given the range of variation of <span class="math">\(\Theta_B\)</span>:</p>
<div class="math">
\[ \begin{align}\begin{aligned}t \in \mathbb{R}, \qquad 0 \leq t \leq 1.\\Once the solutions for :math:`t` are found, we make\end{aligned}\end{align} \]</div>
<p><span class="math">\(\Theta_B' = \arcsin t\)</span>. Note that, for a fixed value of
<span class="math">\(t\)</span>, two values of <span class="math">\(\Theta_B'\)</span> are possible. We choose the
correct one by evaluating the expressions for <span class="math">\(Q\)</span> and <span class="math">\(U\)</span>
and testing which of the two possible choices give the values equal (or
very similar) to the original ones.</p>
<p>The angles <span class="math">\((\theta_B,\phi_B)\)</span> are obtained by doing the
transformation from <span class="math">\((\Theta_B',\Phi_B)\)</span> to the vertical reference
system.</p>
</div>
<div class="section" id="phib-phib-pi">
<h1>PhiB’=PhiB+pi<a class="headerlink" href="#phib-phib-pi" title="Permalink to this headline">¶</a></h1>
<p>Under this change, we have:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\cos 2\Phi_B' = \cos 2\Phi_B, \quad \sin 2\Phi_B' = \sin 2\Phi_B, \quad \cos \Phi_B' = -\cos \Phi_B, \quad \sin \Phi_B' = -\sin \Phi_B.\\Following the same approach, we have to solve for :math:`\Theta_B'` in\end{aligned}\end{align} \]</div>
<div class="math">
\[ \begin{align}\begin{aligned}  \left[ 3 \left( \cos \Theta_B' \cos \theta + \sin\theta \sin\Theta_B' \cos\Phi_B\right)^2-1 \right] \sin^2 \Theta_B' =
  \left[ 3 \left( \cos \Theta_B \cos \theta - \sin\theta \sin\Theta_B \cos\Phi_B\right)^2-1 \right] \sin^2 \Theta_B.\\The solution are obtained as the roots of the same equations as before\end{aligned}\end{align} \]</div>
<p>but now</p>
<div class="math">
\[\begin{split}\begin{aligned}
A &amp;=&amp; -3\cos^2 \theta + 3\sin^2 \theta \cos^2 \Phi_B \nonumber \\
B &amp;=&amp; 3\cos^2 \theta - 1 \nonumber \\
C &amp;=&amp; 6 \cos\theta \sin\theta \cos \Phi_B \nonumber \\
K &amp;=&amp; \left[ 3 \left( \cos \Theta_B \cos \theta - \sin\theta \sin\Theta_B \cos\Phi_B\right)^2-1 \right] \sin^2 \Theta_B.\end{aligned}\end{split}\]</div>
<p>The angles <span class="math">\((\theta_B,\phi_B)\)</span> are obtained by doing the
transformation from <span class="math">\((\Theta_B',\Phi_B+\pi)\)</span> to the vertical
reference system.</p>
</div>
<div class="section" id="phib-phib-pi-2">
<h1>PhiB’=PhiB+pi/2<a class="headerlink" href="#phib-phib-pi-2" title="Permalink to this headline">¶</a></h1>
<p>Under this change, we have:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\cos 2\Phi_B' = -\cos 2\Phi_B, \quad \sin 2\Phi_B' = -\sin 2\Phi_B, \quad \cos \Phi_B' = -\sin \Phi_B, \quad \sin \Phi_B' = \cos \Phi_B.\\Following the same approach, we have to solve for :math:`\Theta_B'` in\end{aligned}\end{align} \]</div>
<div class="math">
\[ \begin{align}\begin{aligned}  \left[ 3 \left( \cos \Theta_B' \cos \theta + \sin\theta \sin\Theta_B' \sin\Phi_B\right)^2-1 \right] \sin^2 \Theta_B' =
  \left[ 3 \left( \cos \Theta_B \cos \theta - \sin\theta \sin\Theta_B \cos\Phi_B\right)^2-1 \right] \sin^2 \Theta_B.\\The solution are obtained as the roots of the same equations as before\end{aligned}\end{align} \]</div>
<p>but now</p>
<div class="math">
\[\begin{split}\begin{aligned}
A &amp;=&amp; -3\cos^2 \theta + 3\sin^2 \theta \sin^2 \Phi_B \nonumber \\
B &amp;=&amp; 3\cos^2 \theta - 1 \nonumber \\
C &amp;=&amp; 6 \cos\theta \sin\theta \sin \Phi_B \nonumber \\
K &amp;=&amp; -\left[ 3 \left( \cos \Theta_B \cos \theta - \sin\theta \sin\Theta_B \cos\Phi_B\right)^2-1 \right] \sin^2 \Theta_B.\end{aligned}\end{split}\]</div>
<p>The angles <span class="math">\((\theta_B,\phi_B)\)</span> are obtained by doing the
transformation from <span class="math">\((\Theta_B',\Phi_B+\pi/2)\)</span> to the vertical
reference system.</p>
</div>
<div class="section" id="id67">
<h1>PhiB’=PhiB-pi/2<a class="headerlink" href="#id67" title="Permalink to this headline">¶</a></h1>
<p>Under this change, we have:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\cos 2\Phi_B' = -\cos 2\Phi_B, \quad \sin 2\Phi_B' = -\sin 2\Phi_B, \quad \cos \Phi_B' = \sin \Phi_B, \quad \sin \Phi_B' = -\cos \Phi_B.\\Following the same approach, we have to solve for :math:`\Theta_B'` in\end{aligned}\end{align} \]</div>
<div class="math">
\[ \begin{align}\begin{aligned}  \left[ 3 \left( \cos \Theta_B' \cos \theta + \sin\theta \sin\Theta_B' \sin\Phi_B\right)^2-1 \right] \sin^2 \Theta_B' =
  \left[ 3 \left( \cos \Theta_B \cos \theta - \sin\theta \sin\Theta_B \cos\Phi_B\right)^2-1 \right] \sin^2 \Theta_B.\\The solution are obtained as the roots of the same equations as before\end{aligned}\end{align} \]</div>
<p>but now</p>
<div class="math">
\[\begin{split}\begin{aligned}
A &amp;=&amp; -3\cos^2 \theta + 3\sin^2 \theta \sin^2 \Phi_B \nonumber \\
B &amp;=&amp; 3\cos^2 \theta - 1 \nonumber \\
C &amp;=&amp; -6 \cos\theta \sin\theta \sin \Phi_B \nonumber \\
K &amp;=&amp; -\left[ 3 \left( \cos \Theta_B \cos \theta - \sin\theta \sin\Theta_B \cos\Phi_B\right)^2-1 \right] \sin^2 \Theta_B.\end{aligned}\end{split}\]</div>
<p>The angles <span class="math">\((\theta_B,\phi_B)\)</span> are obtained by doing the
transformation from <span class="math">\((\Theta_B',\Phi_B-\pi/2)\)</span> to the vertical
reference system.</p>
<p>11 natexlab#1#1</p>
<p>, E.&nbsp;U., &amp; Shortley, G.&nbsp;H. 1935, The Theory of Atomic Spectra
(Cambridge: Cambridge University Press)</p>
<p>, A.&nbsp;R. 1960, Angular Momentum in Quantum Mechanics (Princeton
University Press)</p>
<p>, D.&nbsp;R., Perttunen, C.&nbsp;D., &amp; Stuckmann, B.&nbsp;E. 1993, Journal of
Optimization Theory and Applications, 79, 157</p>
<p>, E., &amp; Landi Deglinnocenti, M. 1985, Sol. Phys., 97, 239</p>
<p>, E., &amp; Landolfi, M. 2004, Polarization in Spectral Lines (Kluwer
Academic Publishers)</p>
<p>, K. 2000, in Allen’s Astrophysical Quantities, ed. A. N. Cox (New York:
Springer Verlag and AIP Press)</p>
<p>, D.&nbsp;E., Durrant, C.&nbsp;J., &amp; Murphy, G.&nbsp;A. 1989, ApJ, 339, 1093</p>
<p>, J. 2003, in Stellar Atmosphere Modeling, ed. I.&nbsp;Hubeny, D.&nbsp;Mihalas, &amp;
K.&nbsp;Werner, ASP Conf. Ser. 288 (San Francisco: ASP), 551</p>
<p>, J., &amp; Asensio Ramos, A. 2007, ApJ, 655, 642</p>
<p>, J., Merenda, L., Centeno, R., Collados, M., &amp; Landi Degl’Innocenti, E.
2005, ApJ, 619, L191</p>
<table class="docutils footnote" frame="void" id="id68" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td>&nbsp;(an acronym for HAnle and ZEeman Light) is one of the IAC computer
programs for the synthesis and inversion of Stokes profiles resulting
from the joint action of the Hanle and Zeeman effects.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id69" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[2]</a></td><td><code class="docutils literal"><span class="pre">http://www.unidata.ucar.edu/software/netcdf/</span></code></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id70" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id28">[3]</a></td><td>More precisely, when the optical thickness of the slab is small in
comparison with the eigenvalues of the matrix <span class="math">\(\mathbf{K}'\)</span>.</td></tr>
</tbody>
</table>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Andres Asensio Ramos.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.0beta1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>